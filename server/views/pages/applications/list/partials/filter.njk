{%- from "../../../../components/accessibleAutocomplete/macro.njk" import accessibleAutocomplete -%}
{% from "govuk/components/button/macro.njk" import govukButton %}

<form novalidate>
  {%- set filterOptionsHtml %}
    <div class="filter-section">
      {{ govukRadios({
        name: "order",
        classes: "govuk-radios--small",
        fieldset: {
          legend: {
            text: "Order",
            classes: "govuk-fieldset__legend--s"
          }
        },
        items: [
          {
            value: "newest",
            text: "Newest",
            checked: not filters.oldestAppFirst
          },
          {
            value: "oldest",
            text: "Oldest",
            checked: filters.oldestAppFirst
          }
        ]
      }) }}
    </div>

    <div class="filter-section">
      {{ govukCheckboxes({
        idPrefix: "status",
        name: "status",
        classes: "govuk-checkboxes--small",
        fieldset: {
          legend: { text: "Status", classes: "govuk-fieldset__legend--s" }
        },
        items: [
          {
            value: "PENDING",
            text: "Pending",
            checked: filters.selectedStatusValues and ("PENDING" in filters.selectedStatusValues)
          },
          {
            value: "CLOSED",
            text: "Closed",
            checked: filters.selectedStatusValues and ("CLOSED" in filters.selectedStatusValues),
            conditional: {
              html: govukCheckboxes({
                idPrefix: "status-closed",
                name: "status",
                classes: "govuk-checkboxes--small",
                items: [
                  {
                    value: "APPROVED",
                    html: 'Approved',
                    checked: filters.selectedStatusValues and ("APPROVED" in filters.selectedStatusValues)
                  },
                  {
                    value: "DECLINED",
                    html: 'Declined',
                    checked: filters.selectedStatusValues and ("DECLINED" in filters.selectedStatusValues)
                  }
                ],
                fieldset: {
                  legend: {
                    text: "Decision",
                    classes: "govuk-visually-hidden"
                  }
                }
              })
            }
          }
        ]
      }) }}
    </div>

    <div class="filter-section">
      {{ accessibleAutocomplete({
        label: "Prisoner name or number",
        nonce: cspNonce,
        selectedLabel: filters.selectedPrisonerLabel,
        selectedValue: filters.selectedPrisonerId
      }) }}

      {{ govukCheckboxes({
        idPrefix: "priority",
        name: "priority",
        classes: "govuk-checkboxes--small",
        items: filters.priority
      }) }}
    </div>

    <div class="filter-section">
      {{ govukCheckboxes({
        idPrefix: "group",
        name: "group",
        classes: "govuk-checkboxes--small",
        fieldset: {
          legend: {
            text: "Department",
            classes: "govuk-fieldset__legend--s"
          }
        },
        items: filters.groups
      }) }}
    </div>

    <div class="filter-section filter-section__app-type">
      {{ govukInput({
        id: "application-type-filter",
        name: "applicationTypeFilter",
        label: {
          text: "Application type",
          classes: "govuk-fieldset__legend--s govuk-!-margin-bottom-2"
        },
        prefix: {
          html: '<svg width="18" height="17" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M17.4444 15.3333L13.2222 11.1111C14 10 14.4444 8.66667 14.4444 7.22222C14.4444 3.22222 11.2222 0 7.22222 0C3.22222 0 0 3.22222 0 7.22222C0 11.2222 3.22222 14.4444 7.22222 14.4444C9 14.4444 10.5556 13.7778 11.7778 12.7778L15.8889 16.8889L17.4444 15.3333ZM2.22222 7.22222C2.22222 4.44444 4.44444 2.22222 7.22222 2.22222C10 2.22222 12.2222 4.44444 12.2222 7.22222C12.2222 10 10 12.2222 7.22222 12.2222C4.44444 12.2222 2.22222 10 2.22222 7.22222Z" fill="black"/>
                </svg>'
        },
        classes: "govuk-input",
        value: filters.applicationTypeFilter
      }) }}
      

      <div class="app-type-filter-checkbox-wrapper">
        {{ govukCheckboxes({
          idPrefix: "type",
          name: "type",
          classes: "govuk-checkboxes--small app-type-filter-scroll-box",
          items: filters.appTypes
        }) }}
      </div>
    </div>

    <div class="filter-section filter-section__submit">
      {{ govukButton({
        text: "Apply filters",
        type: "submit",
        attributes: { "data-test-id": "submit-button-bottom" }
      }) }}
    </div>
  {% endset -%}

  {% set categories = [] %}

  {% if filters.selectedFilters.status | length %}
    {% set categories = categories.concat([{
      heading: { text: "Status" },
      items: filters.selectedFilters.status
    }]) %}
  {% endif %}

  {% if filters.selectedFilters.priority | length %}
    {% set categories = categories.concat([{
      heading: { text: "Priority" },
      items: filters.selectedFilters.priority
    }]) %}
  {% endif %}
  
  {% if filters.selectedFilters.groups | length %}
    {% set categories = categories.concat([{
      heading: { text: "Department" },
      items: filters.selectedFilters.groups
    }]) %}
  {% endif %}

  {% if filters.selectedFilters.types | length %}
    {% set categories = categories.concat([{
      heading: { text: "Application type" },
      items: filters.selectedFilters.types
    }]) %}
  {% endif %}

  {% if filters.selectedPrisonerLabel or categories.length %}
    {{ mojFilter({
      heading: { text: "Filter" },
      submit: {
        attributes: { "data-test-id": "submit-button" }
      },
      optionsHtml: filterOptionsHtml,
      selectedFilters: {
        heading: { text: "Selected filters" },
        clearLink: { text: "Clear filters", href: "/applications" },
        categories: categories
      }
    }) }}
  {% else %}
    {{ mojFilter({
      heading: { text: "Filter" },
      submit: {
        attributes: { "data-test-id": "submit-button" }
      },
      optionsHtml: filterOptionsHtml
    }) }}
  {% endif %}
</form>
